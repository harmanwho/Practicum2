---
title: "CS5200 Practicum II: Harmandeep Sidhu & Robert Zipp"
output: html_notebook
---

# Introduction

This practicum assignment creates a relational database using MySQL for the publicly available IMDB dataset. 

## ERD Diagrams

### Initial diagram
The following is an ERD diagram of the IMDB database after reading data description and normalization. 

![Figure 1: ERD diagram 1 for relational database](ERD.png)
### Ieration 1: Normalized diagram
The following is an ERD diagram of the IMDB database includes added attributes, junction and look-up tables. 

![Figure 2: ERD diagram 2 for relational database](Updated ERD.jpeg)

### Ieration 2: Normalized diagram
The following is an ERD diagram of the IMDB database includes added attributes, junction and look-up tables. 

![Figure 3: ERD diagram 3 for relational database](Final ERD.png)

We can guarantee this model represents the data in at least BCNF because it fulfills the requirements for all normal forms up to and including BCNF.
Exception: As mentioned in the Rubric - ```title.akas``` & ```title.principals``` are attempted to normalize but might be an exception due to the complexity.

First Normal Form: Each column contains atomic values.  
Second Normal Form: The table is in first normal form and all the columns depend on the table's primary key.  
Third Normal Form: The table is in second normal form and all of its columns are not transitively dependent on the primary key.  
BCNF: The table is in third normal form and for any dependency A -> B, A is a super key.

### R Setup

```{r dbconn}

library(DBI)
library(RMariaDB)

db <- DBI::dbConnect(
  drv = RMariaDB::MariaDB(),
  dbname = "yourDB",
  host = "localhost",
  username = "root",
  password = "yourPassword"
)

knitr::opts_chunk$set(connection = "db")

```



### CREATE TABLE Commands

```{sql, connection="db"}
--
-- Table - titleBasics | File - title.basics.tsv
--
CREATE TABLE titleBasics (
    tconst VARCHAR(256) PRIMARY KEY,
    titleType VARCHAR(256),
    primaryTitle VARCHAR(256),
    originalTitle VARCHAR(256),
    isAdult SMALLINT,
    startYear SMALLINT,
    endYear SMALLINT,
    runtimeMinutes INT
);

```

```{sql, connection="db"}
--
-- Table - titleGenre
--
CREATE TABLE titleGenre (
	genreID INT PRIMARY KEY AUTO_INCREMENT,
    genre VARCHAR(256)
);

```

```{sql, connection="db"}
--
-- Table - juncTitleGenre 
--
CREATE TABLE juncTitleGenre (
	tconst VARCHAR(256),
    genreID INT,
    CONSTRAINT titleGenreFK FOREIGN KEY (tconst) REFERENCES titleBasics (tconst),
    CONSTRAINT genreFK FOREIGN KEY (genreID) REFERENCES titleGenre (genreID)
);

```

```{sql, connection="db"}
--
-- Table - titleRatings  | File - title.ratings.tsv
--
CREATE TABLE titleRatings (
	tconst VARCHAR(256),
    averageRating INT,
    numVotes INT,
    CONSTRAINT titleRatingFK FOREIGN KEY (tconst) REFERENCES titleBasics (tconst)
);

```

```{sql, connection="db"}
--
-- Table - titleEpisodes  | File - title.episodes.tsv
--
CREATE TABLE titleEpisodes (
	tconst VARCHAR(256) PRIMARY KEY,
    parentTconst VARCHAR(256),
    seasonNumber INT,
    episodeNumber INT,
    CONSTRAINT titleEpisodeFK FOREIGN KEY (parentTconst) REFERENCES titleBasics (tconst)
);

```

```{sql, connection="db"}
--
-- Table - crewRoles  | File - title.crew.tsv
--
CREATE TABLE crewRoles (
	roleID INT PRIMARY KEY AUTO_INCREMENT,
    role VARCHAR(256)
);
```

```{sql, connection="db"}
--
-- Table - juncCrewRole 
--
CREATE TABLE juncCrewRole (
	tconst VARCHAR(256),
    nconst VARCHAR(256),
    roleID INT,
    CONSTRAINT titleCrewFK FOREIGN KEY (tconst) REFERENCES titleBasics (tconst),
    CONSTRAINT roleCrewFK FOREIGN KEY (roleID) REFERENCES crewRoles (roleID)
);
```

```{sql, connection="db"}
-- Main table - nameBasics --

--
-- Table - nameBasics | File - name.basics.tsv
--
CREATE TABLE nameBasics (
	nconst VARCHAR(256) PRIMARY KEY,
	primaryName VARCHAR(256),
    birthYear SMALLINT,
    deathYear SMALLINT,
    age INT,
    numTitlesCount INT
);
```

```{sql, connection="db"}
--
-- Table - juncNameTitles
--
CREATE TABLE juncNameTitles (
	nconst VARCHAR(256),
    tconst VARCHAR(256),
    CONSTRAINT nameFK FOREIGN KEY (nconst) REFERENCES nameBasics (nconst),
    CONSTRAINT titleFK FOREIGN KEY (tconst) REFERENCES titleBasics (tconst)
);
```

```{sql, connection="db"}
--
-- Table - nameProfession
--
CREATE TABLE nameProfession (
	  professionID INT PRIMARY KEY AUTO_INCREMENT,
    primaryProfession VARCHAR(256)
);

```

```{sql, connection="db"}
--
-- Table - juncNameProfession
--
CREATE TABLE juncNameProfession (
	nconst VARCHAR(256),
    professionID INT,
    CONSTRAINT nameProfessionFK FOREIGN KEY (nconst) REFERENCES nameBasics (nconst),
    CONSTRAINT professionFK FOREIGN KEY (professionID) REFERENCES nameProfession (professionID)
);
```

```{sql, connection="db"}
--
-- Table - titlePrincipals | File - title.principals.tsv
--
CREATE TABLE titlePrincipals (
	tconst VARCHAR(256),
    ordering INT,
    nconst VARCHAR(256),
    category VARCHAR(256),
    job VARCHAR(256),
    characters VARCHAR(256),
    CONSTRAINT principalTitleFK FOREIGN KEY (tconst) REFERENCES titleBasics (tconst),
    CONSTRAINT principalNameFK FOREIGN KEY (nconst) REFERENCES nameBasics (nconst)
);
```

```{sql, connection="db"}
show tables;
```
## Load Data into the tables

### titleBasics, titleGenres, juncTitleGenre load
``` {r, connection="db"}
#pre-script
library("data.table")
library(tidyr)

#read the file into a data.table
fread("/Users/harmansidhu/Documents/DBMS/Practicums/imdbData/title.basics.tsv", sep = "\t", header= TRUE, na.strings="\\N", nrows=50000)-> pre

# Extract genres and corresponding tconst from file and split into individual rows
genres <- pre[, list(tconst, genres)]
genresDF <- as.data.frame(genres)
#head(genresDF)

#head(genresColDF)
#

#rename column name 'genres' to 'genre'
genresDF <- separate_rows(genresDF, tconst, genres, convert = TRUE)
renamedGenre <- genresDF %>% rename(genre = genres)
print(renamedGenre)

genreTableData <- distinct(subset(renamedGenre, select = -c(tconst)), genre)
#print(genreTableData)

#Remove the row  genres form the data.table
pre[, genres:=NULL]
preDF <- as.data.frame(pre)
#head(pre)

#Insert data into MySQL Table
dbWriteTable(db, value = preDF, row.names = FALSE, name = "titleBasics", append = TRUE)
dbReadTable(db, "titleBasics")

#Insert data into titleGenre and create corresponding PK
dbWriteTable(db, value = genreTableData, row.names = FALSE, name = "titleGenre", append = TRUE)
genreWithID <- dbReadTable(db, "titleGenre")
print(genreWithID)

#Merge dataframes to create the junction table data
junctionGenre <- merge(renamedGenre, genreWithID, by="genre", all.x = FALSE)
junctionGenre <- subset(junctionGenre, select = -c(genre))
print(junctionGenre)
dbWriteTable(db, value = junctionGenre, row.names = FALSE, name = "juncTitleGenre", append = TRUE)
dbReadTable(db, "juncTitleGenre")
```

### titleRatings load
``` {r, connection="db"}
library("data.table")
fread("/Users/harmansidhu/Documents/DBMS/Practicums/imdbData/title.ratings.tsv", sep = "\t", header= TRUE, na.strings="\\N", nrows=50000) -> ratings
ratingsDF <- as.data.frame(ratings)
head(ratingsDF)
dbWriteTable(db, value = ratingsDF, row.names = FALSE, name = "titleRatings", overwrite = TRUE)
dbReadTable(db, "titleRatings")
```


### titleEpisodes load
``` {r, connection="db"}
library("data.table")
fread("/Users/harmansidhu/Documents/DBMS/Practicums/imdbData/title.episode.tsv", sep = "\t", header= TRUE, na.strings="\\N", nrows=50000) -> episodes
episodesDF <- as.data.frame(episodes)
head(episodesDF)
dbWriteTable(db, value = episodesDF, row.names = FALSE, name = "titleEpisodes", overwrite = TRUE)
dbReadTable(db, "titleEpisodes")
```

### nameBasics, juncNameProfession, nameProfession load

```{r, connection="db"}

	
library(tidyr)
library(dplyr)
library(stringr)

# initial import
nameData <- fread(file = '/Users/harmansidhu/Documents/DBMS/Practicums/imdbData/name.basics.tsv', sep = "\t", header= TRUE, na.strings="\\N", nrows=50000) 

nameBasics <- as.data.frame(nameData)
#junction table create
juncNameProfession <- data.frame(
                 nconst=character(50000), 
                 professionID=sample(1:60000, 50000, replace=FALSE))
str(juncNameProfession)
juncNameProfession$nconst = nameBasics$nconst

#nameProfession creation
nameProfession <- data.frame(
                 professionID =character(50000), 
                 primaryProfession = character(50000))
                
nameProfession$professionID <- juncNameProfession$professionID
nameProfession$primaryProfession <- nameBasics$primaryProfession
nameProfession <- nameProfession %>% tidyr::separate(primaryProfession, into = c("primaryProfession", "primaryProf1", "primaryProf2"))

nameBasics = subset(nameBasics, select = -c(primaryProfession))

#TODO: numTitlesCount is to be left empty now and calculated later
numTitlesCount <- stringr::str_count(nameBasics$knownForTitles, ",")
numTitlesCount <- numTitlesCount + 1
head(numTitlesCount)
nameBasics$numTitlesCount <- numTitlesCount
nameBasics = subset(nameBasics, select = -c(knownForTitles))
head(nameBasics)
#dbReadTable("nameBasics")
dbWriteTable(db, value = nameBasics, row.names = FALSE, name = "nameBasics", append = TRUE)
```


